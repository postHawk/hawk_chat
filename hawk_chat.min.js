
(function(b){var a={init:function(c){if(!HAWK_API){var g=this;setTimeout(function(){g.init(c)},500);return}if(HAWK_API.initialized){return}var e=b.extend(a.getDefaultSettings(),c);if(!e.messageFormat){throw"Empty message format"}if(e.userId===null||e.userId===undefined){throw"User id not set"}e.container=b(this);var f=e.container;var d=e.chatBody;f.html(d).data("hawk_chat",e);HAWK_API.bind_handler("hawk.message",a.onMessage(e));HAWK_API.bind_handler("hawk.initialized",a.onInit(e));HAWK_API.bind_handler("hawk.get_by_group",a.showUsers(e));b("#chat_send_message",f).keyup(a.send(e));a.initTab(e);a.registerUser(e);if(!e.useTabs){b(e.tabsContainerSelector).hide()}if(!e.inline){if(f.draggable){b("#chat").draggable({scroll:false,handle:e.chatHeaderSelector})}else{console.error("Для перемещаемого чата необходимо наличие jquery ui draggable")}}},initTab:function(c){c.container.find(c.tabForCopySelector).click(a.changeTab(c));a.addTab.call(c.container,c.groupName,true)},registerUser:function(c){b.post(c.serverSideUrl,{user_id:c.userId,group_id:[c.groupName],action:"register_user"},function(d){d=JSON.parse(d);if(!d.error){HAWK_API.init({user_id:c.userId,url:c.serverUrl,debug:true})}})},getDefaultSettings:function(){return{chatBody:a.getDeafaultHtml(),userId:null,groupName:"default_group",serverUrl:"wss://post-hawk.com:2222",messageFormat:a.getDefaultMessageFormat(),userFormat:a.getDefaultUserFormat(),serverSideUrl:"/chat.php",onlineUserClass:"chat-online",offlineUserClass:"chat-offline",currentUserClass:"chat-current",tabForCopySelector:".chat-tab.main",tabsContainerSelector:".chat-tabs",tabSelector:".chat-tab",tabNameSelector:".chat-tab-name",messagePanelSelector:".chat-mesasge-panel",textPanelSelector:".chat-text-panel",bodySelector:".chat-body",countNewMessageSelector:".chat-tab-count-new",chatHeaderSelector:".chat-header",inline:true,useTabs:true,onInit:function(){},onInMessage:function(d,c){return c},onOutMessage:function(c){},onPrivateMessage:function(d,c){return c},onNewPrivate:function(c){},onUserUpdate:function(c){return c},onChangeTab:function(c,d){}}},onMessage:function(c){return function(k,g){if(g.from===c.userId){return}var l=c.messageFormat.match(/\{[\w]+\}/g);if(l===null){throw"Invalid message format"}var m=c.messageFormat;if(typeof g.text==="object"){l.map(function(e){return e.replace(/\{|\}/g,"")}).forEach(function(e){if(g.text.hasOwnProperty(e)){var n=new RegExp("\\{"+e+"\\}","g");m=m.replace(n,g.text[e])}})}else{m=g.text}var d=g.to_group||g.from;var h=b('[data-hawk-panel_id="'+d+'_panel"]');if(!h.size()){c.container.hawkChat("addTab",d);h=b('[data-hawk-panel_id="'+d+'_panel"]');if(!g.to_group&&c.onNewPrivate==="function"){c.onNewPrivate.call(c.container,g.from)}}if(!h.is(":visible")){var f=h.data().hawkPanel_id;var j=c.container.find(c.containertabSelector+'[data-href="'+f+'"] '+c.countNewMessageSelector);var i=0|j.text().replace("+","");j.text("+"+ ++i)}if(typeof c.onInMessage==="function"){m=c.onInMessage.call(c.container,g,m)}if(!g.to_group&&c.onPrivateMessage==="function"){m=c.onPrivateMessage.call(c.container,g,m)}h.append(m)}},onInit:function(c){return function(){if(typeof c.onInit==="function"){c.onInit.call(c.container)}HAWK_API.get_users_by_group([c.groupName]);setTimeout(function(){HAWK_API.get_users_by_group([c.groupName])},30000)}},showUsers:function(c){return function(d,f){if(f.result&&f.result.length){HAWK_API.print_debug(f);b("#chat_online_u,#chat_offline_u").empty();if(typeof c.onUserUpdate==="function"){c.onUserUpdate.call(c.container,f.result)}f.result.forEach(function(h){var e="#chat_online_u";var i=c.userFormat.replace(/\{login\}|\{id\}/g,h.user);i=b(i);var g=c.onlineUserClass;if(!h.online&&h.user!=HAWK_API.get_user_id()){e="#chat_offline_u";g=c.offlineUserClass}else{if(h.user===HAWK_API.get_user_id()){g=c.currentUserClass}}i.addClass(g);if(h.online&&c.useTabs){i.click(a.createPrivate(c))}b(e).append(i)})}}},send:function(c){return function(i){if(i.keyCode===13){var h=b(this);var g=new Date().toLocaleString("ru",{year:"numeric",month:"2-digit",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});var k=c.messageFormat.replace("{time}",g).replace("{from_login}",c.userId).replace("{message}",h.val());var d=b(k);d.addClass("chat-message-curent-user");c.container.find(c.messagePanelSelector+".active").append(d);var f=c.container.find(c.tabSelector+".active");var l=f.attr("data-href").replace("_panel","");if(f.data().isGroup){l={group:[l]}}else{l={user:l}}var j={to:l,text:{time:g,from_login:c.userId,message:h.val()}};if(typeof c.onOutMessage==="function"){c.onOutMessage.call(c.container,j)}HAWK_API.send_message(j);h.val("")}}},createPrivate:function(c){return function(){var d=b(this).data().hawkId;if(d!=c.userId){c.container.hawkChat("addTab",d)}}},addTab:function(i,h){var d=b(this);var g=d.data("hawk_chat");var e=d.find(g.tabsContainerSelector);h=h||false;if(e.find('[data-href="'+i+'_panel"]').size()){return}var f=e.find(g.tabForCopySelector).clone(true);f.removeClass("main").addClass("active").attr("data-href",i+"_panel").attr("data-is-group",h).css("display","table-cell").find(g.tabNameSelector).html(i);e.find(g.tabSelector).removeClass("active");e.append(f);d.find(g.messagePanelSelector).removeClass("active").hide();var c=d.find('[data-hawk-panel_id="chat_main_panel"]').clone(true);c.attr("data-hawk-panel_id",i+"_panel").addClass("active").show();d.find(g.textPanelSelector).before(c)},changeTab:function(c){return function(){var g=b(this);var f=g.data().href;var d=g.parents(c.bodySelector);var e=d.find(c.tabSelector+" active");d.find(c.messagePanelSelector).removeClass("active").hide();d.find('[data-hawk-panel_id="'+f+'"]').addClass("active").show();d.find(c.tabSelector).removeClass("active");g.addClass("active");g.find(c.countNewMessageSelector).empty();if(c.onChangeTab==="function"){c.onChangeTab.call(c.container,e,g)}}},getDeafaultHtml:function(){return'<div class="chat-container"> 				<div id="" class="chat-header"> 					<div class="chat-title">Post Hawk Chat</div> 					<div class="chat-logo"> 						<img src="/css/landing/logo_main.png"> 					</div> 				</div> 				<div class="chat-body"> 					<div class="chat-left-panel"> 						<div class="chat-separator"><span>В сети</span></div> 						<div class="chat-online-u" id="chat_online_u"></div> 						<div class="chat-separator"><span>Не в сети</span></div> 						<div class="chat-offline-u" id="chat_offline_u"></div> 					</div> 					<div class="chat-right-panel"> 						<div class="chat-tabs">							<div style="display: none;" data-href="chat_main_panel" class="chat-tab main">								<span class="chat-tab-name"></span><span class="chat-tab-count-new"></span>							</div>						</div> 						<div style="display: none;" data-hawk-panel_id="chat_main_panel" class="chat-mesasge-panel"></div> 						<div class="chat-text-panel"> 							<input id="chat_send_message" placeholder="Введите сообщение" class="chat-text-input" type="text"> 						</div> 					</div> 				</div> 			</div>'},getDefaultMessageFormat:function(){return'<div class="chat-row" title="{time}">				<span class="chat-row-login">{from_login}</span>: 				<span class="chat-row-message">{message}</span>			</div>'},getDefaultUserFormat:function(){return'<div data-hawk-id="{id}">{login}</div>'},setTitleMainTab:function(c){var d=b(this).data("hawk_chat");b(this).find(d.tabSelector).eq(0).find(d.tabNameSelector).html(c)}};b.fn.hawkChat=function(c){if(a[c]){return a[c].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof c==="object"||!c){return a.init.apply(this,arguments)}else{b.error("Метод с именем "+c+" не существует для jQuery.hawkChat")}}}})(jQuery);