
(function(c){var a={init:function(d){if(!HAWK_API){var g=this;setTimeout(function(){g.init(d)},500);return}if(HAWK_API.initialized){return}b=c.extend(b,d);if(!b.inMessageFormat){throw"Empty message format"}if(b.userId===null||b.userId===undefined){throw"User id not set"}b.container=c(this);var f=b.container;var e=b.chatBody;f.html(e).data("hawk_chat",b);HAWK_API.bind_handler("message",a.onMessage);HAWK_API.bind_handler("initialized",a.onInit);HAWK_API.bind_handler("get_by_group",a.showUsers);HAWK_API.bind_handler("get_group_by_simple_user",a.showGroups);HAWK_API.bind_handler("remove_from_groups",function(){HAWK_API.get_groups_by_user()});c(b.textInputSelector,f).keyup(a.send);a.initTab();a.registerUser();if(!b.useTabs){c(b.tabsContainerSelector).hide()}if(!b.inline){if(f.draggable){c("#chat").draggable({scroll:false,handle:b.chatHeaderSelector})}else{console.error("Для перемещаемого чата необходимо наличие jquery ui draggable")}}if(!b.useUserList){c(b.leftPanelSelector).hide()}c(b.titleSelector).html(b.title);[{selector:b.tabsWrapperSelector,axis:"x"},{selector:b.onlineWrapperSelector,axis:"xy"},{selector:b.offlineWrapperSelector,axis:"xy"}].forEach(a.applyStyleToScroll)},initTab:function(){b.container.find(b.tabForCopySelector).click(a.changeTab);if(b.groupName){a.addTab.call(b.container,b.groupName,true,true)}if((typeof b.openWithUser)==="object"&&b.openWithUser.length){b.openWithUser.forEach(function(d){a.addTab.call(b.container,d,false)})}},registerUser:function(){c.post(b.serverSideUrl,{user_id:b.userId,group_id:((b.groupName)?[b.groupName]:null),action:"register_user"},function(d){d=JSON.parse(d);if(!d.error){HAWK_API.init({user_id:b.userId,url:b.serverUrl})}})},onMessage:function(i,k){if(k.from===b.userId||k.event!="hawk.chat_message"){return}var d=k.to_group||k.from;var h=c('[data-hawk-panel_id="'+d+'_panel"]');if(!h.size()){b.container.hawkChat("addTab",d);h=c('[data-hawk-panel_id="'+d+'_panel"]');if(!k.to_group&&b.onNewPrivate==="function"){b.onNewPrivate.call(b.container,k.from)}}if(!h.is(":visible")){var l=h.data().hawkPanel_id;var f=b.container.find(b.containertabSelector+'[data-href="'+l+'"] '+b.countNewMessageSelector);var g=0|f.text().replace("+","");f.text("+"+ ++g)}var j=a.compileMessageString(k);if(typeof b.onInMessage==="function"){j=b.onInMessage.call(b.container,k,j);if(j===-1){j=a.compileMessageString(k)}}if(!k.to_group&&b.onPrivateMessage==="function"){j=b.onPrivateMessage.call(b.container,k,j)}if(j!==false){if(h.find(".mCSB_container").size()){h=h.find(".mCSB_container")}h.append(j);if(typeof b.container.mCustomScrollbar!=="undefined"){h.parent().parent().mCustomScrollbar("scrollTo","bottom")}}},compileMessageString:function(f){var d=b.inMessageFormat.match(/\{[\w]+\}/g);if(d===null){throw"Invalid message format"}var e=b.inMessageFormat;if(typeof f.text==="object"){d.map(function(g){return g.replace(/\{|\}/g,"")}).forEach(function(g){if(f.text.hasOwnProperty(g)){var h=new RegExp("\\{"+g+"\\}","g");e=e.replace(h,f.text[g])}})}else{e=f.text}return e},onInit:function(){if(typeof b.onInit==="function"){b.onInit.call(b.container)}HAWK_API.get_groups_by_user();setInterval(function(){HAWK_API.get_groups_by_user()},30000);c(b.textInputSelector,b.container).removeAttr("disabled");a.addGroup()},showUsers:function(d,f){if(f.result&&typeof f.result==="object"){HAWK_API.print_debug(f);c(b.onlineWrapperSelector+" "+b.usersContainerSelector+","+b.offlineWrapperSelector+" "+b.usersContainerSelector).empty();if(typeof b.onUserUpdate==="function"){b.onUserUpdate.call(b.container,f.result)}f.result.forEach(function(e){for(var g in e){e[g].users.forEach(function(j){var h=b.onlineWrapperSelector+" "+b.usersContainerSelector;var i=b.onlineUserClass;if(!j.online&&j.user!=HAWK_API.get_user_id()){h=b.offlineWrapperSelector+" "+b.usersContainerSelector;i=b.offlineUserClass}else{if(j.user===HAWK_API.get_user_id()){i=b.currentUserClass}}h=c(h);if(!h.find('[data-hawk-id="'+j.user+'"]').size()){var k=b.userFormat.replace(/\{login\}|\{id\}/g,j.user);k=c(k);k.addClass(i);if(j.online&&b.useTabs){k.click(a.createPrivate)}h.append(k)}})}})}},showGroups:function(f,g){c(b.groupsWrapperSelector+" "+b.usersContainerSelector).empty();var d=[];g.result.forEach(function(i){var e=b.groupsWrapperSelector+" "+b.usersContainerSelector;var h=b.groupFormat.replace(/\{login\}|\{id\}/g,i.name);h=c(h);h.not("img").click(function(j){a.addTab.call(b.container,i.name,true)});h.find(b.exitGroupButtonSelector).click(a.exitFromGroup);c(e).append(h);d.push(i.name)});HAWK_API.get_users_by_group(d)},exitFromGroup:function(f){f.stopPropagation();var d=c(this).data().hawkId;if(d){HAWK_API.remove_user_from_group([d])}},addGroup:function(){c(b.createGroupButtonSelector).click(function(){c(b.onlineWrapperSelector+" "+b.usersContainerSelector+" "+b.userToGroupAddSelector).show();c(b.createGroupButtonSelector).hide();c(b.groupActionsWrapperSelector).show()});c(b.groupActionsWrapperSelector+" "+b.addGroupButtonSelector).click(function(){var e=c(b.onlineWrapperSelector+" "+b.usersContainerSelector+" "+b.userToGroupAddSelector+":checked");if(!e.size()){alert("Для создания группы необходимо выбрать пользователей")}else{var d=prompt('Придумайте название группы \r\n(допускаются символы латинского алфавита и "_"):');if(d.trim()!==""&&HAWK_API.check_user_id(d)){HAWK_API.add_user_to_group([d]);e.each(function(){HAWK_API.add_user_to_group([d],this.value)})}setTimeout(function(){HAWK_API.get_groups_by_user()},1000);c(b.createGroupButtonSelector).show();c(b.groupActionsWrapperSelector).hide();c(b.onlineWrapperSelector+" "+b.usersContainerSelector+" "+b.userToGroupAddSelector).hide()}});c(b.groupActionsWrapperSelector+" "+b.exitGroupButtonSelector).click(function(){c(b.onlineWrapperSelector+" "+b.usersContainerSelector+" "+b.userToGroupAddSelector).hide();c(b.createGroupButtonSelector).show();c(b.groupActionsWrapperSelector).hide()})},send:function(j){if(j.keyCode===13){var l=c(this);var g=new Date().toLocaleString("ru",{year:"numeric",month:"2-digit",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});var k=b.outMessageFormat.replace("{time}",g).replace("{from_login}",b.userId.substr(0,10)).replace("{message}",l.val());var h=c(k);h.addClass("chat-message-curent-user");var i=b.container.find(b.messagePanelSelector+".active");if(i.find(".mCSB_container").size()){i=i.find(".mCSB_container")}i.append(k);if(typeof b.container.mCustomScrollbar!=="undefined"){i.parent().parent().mCustomScrollbar("scrollTo","bottom")}var f=b.container.find(b.tabSelector+".active");var m=f.attr("data-href").replace("_panel","");if(f.data().isGroup){m={group:[m]}}else{m={user:m}}var d={to:m,text:{time:g,from_login:b.userId,message:l.val()},event:"hawk.chat_message"};if(typeof b.onOutMessage==="function"){b.onOutMessage.call(b.container,d)}HAWK_API.send_message(d);l.val("")}},createPrivate:function(d){var f=c(this).data().hawkId;if(!f||d.target.nodeName==="INPUT"||d.target.nodeName==="IMG"){d.stopPropagation()}else{if(f!=b.userId){b.container.hawkChat("addTab",f)}}},addTab:function(j,i,f){var e=b.container;var g=e.find(b.tabsContainerSelector);i=i||false;f=f||false;var h=g.find('[data-href="'+j+'_panel"]');if(h.size()){h.click();return}h=g.find(b.tabForCopySelector).clone(true);h.removeClass("main").addClass("active").attr("data-href",j+"_panel").attr("data-isMain",f).attr("title",j).attr("data-is-group",i).css("display","block").find(b.tabNameSelector).html(j.substr(0,10));g.find(b.tabSelector).removeClass("active");g.find(b.tabForCopySelector).parent().append(h);e.find(b.messagePanelSelector).removeClass("active").hide();var d=e.find('[data-hawk-panel_id="chat_main_panel"]').clone(true);d.attr("data-hawk-panel_id",j+"_panel").addClass("active").show();e.find(b.textPanelSelector).before(d);a.applyStyleToScroll({selector:d,axis:"y"});h.find(b.closeTabSelector).click(a.closeTab);c(b.textInputSelector).show()},changeTab:function(){var g=c(this);var f=g.data().href;var d=g.parents(b.bodySelector);var e=d.find(b.tabSelector+".active");d.find(b.messagePanelSelector).removeClass("active").hide();d.find('[data-hawk-panel_id="'+f+'"]').addClass("active").show();d.find(b.tabSelector).removeClass("active");g.addClass("active");g.find(b.countNewMessageSelector).empty();if(b.onChangeTab==="function"){b.onChangeTab.call(b.container,e,g)}},closeTab:function(){var e=c(this);var d=e.parent();c('[data-hawk-panel_id="'+d.data().href+'"]').remove();d.remove();c(b.tabsContainerSelector,b.container).find(b.tabSelector+":last").not(b.tabForCopySelector).click();if(!b.container.find(b.messagePanelSelector+":visible").size()){c(b.textInputSelector).hide()}},applyStyleToScroll:function(d){var e=null;if(!b.customScroll){e=a.stylizationScroll}else{if(typeof b.customScroll==="function"){e=b.customScroll}}if(e){e(d)}},stylizationScroll:function(e){if(typeof b.container.mCustomScrollbar!=="undefined"){var d=b.container;c(e.selector,d).mCustomScrollbar({axis:e.axis,scrollButtons:{enable:true},theme:"dark-thin",scrollInertia:200,autoHideScrollbar:true,autoExpandScrollbar:true,advanced:{autoExpandHorizontalScroll:true}})}},getDefaultHtml:function(){return'<div class="chat-container"> 				<div id="" class="chat-header"> 					<div class="chat-title">Post Hawk Chat</div> 					<div class="chat-logo"> 						<img> 					</div> 				</div> 				<div class="chat-body"> 					<div class="chat-left-panel"> 						<div class="chat-separator">							<span>Группы</span>							<span id="create_new_group">								<img class="add-hawk-group">							</span>							<span id="actions_new_group">								<img class="add-hawk-group-confirm">								<img class="add-hawk-group-dismiss">							</span>						</div> 						<div class="chat-groups-u" id="chat_groups_u"><table class="chat-users"></table></div> 						<div class="chat-separator"><span>В сети</span></div> 						<div class="chat-online-u" id="chat_online_u"><table class="chat-users"></table></div> 						<div class="chat-separator"><span>Не в сети</span></div> 						<div class="chat-offline-u" id="chat_offline_u"><table class="chat-users"></table></div> 					</div> 					<div class="chat-right-panel"> 						<div class="chat-tabs">							<ul>								<li style="display: none;" data-href="chat_main_panel" class="chat-tab main">									<span class="chat-tab-name"></span>									<span class="chat-tab-count-new"></span>									<span class="chat-close-tab">x</span>								</li>							</ul> 						</div>						<div style="display: none;" data-hawk-panel_id="chat_main_panel" class="chat-mesasge-panel"></div> 						<div class="chat-text-panel"> 							<input disabled="disabled" id="chat_send_message" placeholder="Введите сообщение" class="chat-text-input" type="text"> 						</div> 					</div> 				</div> 			</div>'},getDefaultInMessageFormat:function(){return'<div class="chat-row" title="{time}">				<span class="chat-row-login">{from_login}</span>: 				<span class="chat-row-message">{message}</span>			</div>'},getDefaultUserFormat:function(){return'<tr data-hawk-id="{id}">						<td><input value="{login}" class="hawk-new-users-group" style="display: none;" type="checkbox" class="add_to_hawk_group"></td>						<td>{login}</td>					</tr>'},getDefaultGroupFormat:function(){return'<tr data-hawk-id="{id}"><td>{login}</td><td><img data-hawk-id="{id}" class="add-hawk-group-dismiss"></td></tr>'},setTitleMainTab:function(d){var e=c(this).data("hawk_chat");c(this).find(e.tabSelector).eq(0).find(e.tabNameSelector).html(d)}};var b={chatBody:a.getDefaultHtml(),userId:null,groupName:"default_group",serverUrl:"wss://post-hawk.com:2222",inMessageFormat:a.getDefaultInMessageFormat(),outMessageFormat:a.getDefaultInMessageFormat(),userFormat:a.getDefaultUserFormat(),groupFormat:a.getDefaultGroupFormat(),serverSideUrl:"/chat.php",onlineUserClass:"chat-online",offlineUserClass:"chat-offline",currentUserClass:"chat-current",tabForCopySelector:".chat-tab.main",tabsContainerSelector:".chat-tabs ul",tabsWrapperSelector:".chat-tabs",tabSelector:".chat-tab",tabNameSelector:".chat-tab-name",messagePanelSelector:".chat-mesasge-panel",textPanelSelector:".chat-text-panel",bodySelector:".chat-body",countNewMessageSelector:".chat-tab-count-new",chatHeaderSelector:".chat-header",inline:true,useTabs:true,useUserList:true,leftPanelSelector:".chat-left-panel",title:"Post Hawk Chat",titleSelector:".chat-title",openWithUser:[],closeTabSelector:".chat-close-tab",textInputSelector:"#chat_send_message",onlineWrapperSelector:"#chat_online_u",groupsWrapperSelector:"#chat_groups_u",offlineWrapperSelector:"#chat_offline_u",usersContainerSelector:"table.chat-users",exitGroupButtonSelector:".add-hawk-group-dismiss",addGroupButtonSelector:".add-hawk-group-confirm",userToGroupAddSelector:".hawk-new-users-group",createGroupButtonSelector:"#create_new_group",groupActionsWrapperSelector:"#actions_new_group",onInit:function(){},onInMessage:function(e,d){return d},onOutMessage:function(d){},onPrivateMessage:function(e,d){return d},onNewPrivate:function(d){},onUserUpdate:function(d){return d},onChangeTab:function(d,e){},customScroll:false};c.fn.hawkChat=function(d){if(a[d]){return a[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){return a.init.apply(this,arguments)}else{c.error("Метод с именем "+d+" не существует для jQuery.hawkChat")}}}})(jQuery);